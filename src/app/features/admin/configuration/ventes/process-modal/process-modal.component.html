@if (service.procedesModalOpen() && service.selectedOperation()) {
  <div class="modal fade show d-block" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Procédés – {{ service.selectedOperation().name }}</h5>
          <button type="button" class="btn-close" (click)="close()" aria-label="Fermer"></button>
        </div>

        <div class="modal-body">
          <button class="btn btn-sm btn-primary mb-3" (click)="addProcede(service.selectedOperation())">
            <i class="bi bi-plus"></i> Ajouter un procédé
          </button>

          @if (service.selectedOperation().procedes.length === 0) {
            <div class="alert alert-warning">Aucun procédé configuré.</div>
          } @else {
            <div class="accordion" id="procedAccordion">
              @for (p of service.selectedOperation().procedes; track p.id; let i = $index) {
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button"
                            data-bs-toggle="collapse"
                            [attr.data-bs-target]="'#collapse' + p.id">
                      {{ p.main.name }}
                    </button>
                  </h2>
                  <div [id]="'collapse' + p.id" class="accordion-collapse collapse"
                       data-bs-parent="#procedAccordion">
                    <div class="accordion-body">

                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Produit principal :</strong>
                        <button class="btn btn-sm btn-danger"
                                (click)="removeProcede(service.selectedOperation(), p)">
                          Supprimer procédé
                        </button>
                      </div>
                      <input [(ngModel)]="p.main.name" class="form-control form-control-sm mb-2"
                             placeholder="Nom produit principal">
                      <input [(ngModel)]="p.main.unit" class="form-control form-control-sm"
                             placeholder="Unité">

                      <hr>

                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>Produits associés :</strong>
                        <button class="btn btn-sm btn-outline-primary"
                                (click)="addProduct(p)">
                          Ajouter produit
                        </button>
                      </div>

                      @if (p.products.length === 0) {
                        <small class="text-muted">Aucun produit associé.</small>
                      } @else {
                        <ul class="list-group">
                          @for (prod of p.products; track prod.id) {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span>
                              <input [(ngModel)]="prod.name" class="form-control form-control-sm d-inline-block w-auto"
                                     placeholder="Nom produit">
                              <input [(ngModel)]="prod.unit" class="form-control form-control-sm d-inline-block w-auto ms-2"
                                     placeholder="Unité">
                            </span>
                              <button class="btn btn-sm btn-outline-danger"
                                      (click)="removeProduct(p, prod)">
                                Supprimer
                              </button>
                            </li>
                          }
                        </ul>
                      }
                    </div>
                  </div>
                </div>
              }
            </div>
          }
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="close()">Fermer</button>
        </div>
      </div>
    </div>
  </div>

}
