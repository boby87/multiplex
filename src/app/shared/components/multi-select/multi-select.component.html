<div class="multi-select-wrapper" [class.disabled]="disabled">
  <div class="multi-select-container form-control" (click)="toggleDropdown()">
    @if (selectedValues.length === 0) {
      <span class="placeholder">{{ label() }}</span>
    } @else {
      @for (key of selectedValues; track key) {
        <span class="badge bg-light d-flex align-items-center me-1">
          @if (primaryValue === key) {
            <i class="fas fa-star star-primary-badge"></i>
          }
          {{ getLabelForValue(key) }}
          <span
            (click)="$event.stopPropagation(); removeSelected(key)"
            class="remove-btn ms-2"
            title="Supprimer">&times;</span>
        </span>
      }
    }
    <i class="fas fa-chevron-down dropdown-arrow"></i>
  </div>

  @if (isDropdownOpen()) {
    <div class="dropdown-menu-custom shadow-sm">
      <div class="p-2">
        <input
          type="text"
          [ngModel]="searchTerm()"
          (ngModelChange)="searchTerm.set($event)"
          [placeholder]="placeholder()"
          class="form-control form-control-sm"
        />
      </div>
      <ul class="list-group list-group-flush dropdown-list">
        @for (opt of filteredOptions(); track opt.key) {
          <li
            class="list-group-item list-group-item-action d-flex align-items-center"
            (click)="toggleSelection(opt)"
          >
            <input
              class="form-check-input me-2"
              type="checkbox"
              [checked]="selectedValues.includes(opt.key)"
              readonly
            />
            <span class="flex-grow-1">{{ opt.value }}</span>

            @if (withPrincipalElement() && selectedValues.includes(opt.key)) {
              @if (primaryValue === opt.key) {
                <i class="fas fa-star star-primary" title="Élément principal"></i>
              } @else {
                <i
                  class="far fa-star star-selector"
                  title="Définir comme principal"
                  (click)="$event.stopPropagation(); setPrimary(opt.key)"></i>
              }
            }
          </li>
        } @empty {
          <li class="list-group-item text-muted">Aucun résultat</li>
        }
      </ul>
    </div>
  }
</div>
